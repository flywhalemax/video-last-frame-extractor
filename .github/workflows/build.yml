name: 构建多平台可执行文件

on:
  # 创建 Release 时自动触发
  release:
    types: [created]
  # 允许手动触发
  workflow_dispatch:

# 添加权限声明，允许上传构建产物到 Release
permissions:
  contents: write

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: windows-latest
            name: Windows
            artifact_name: VideoLastFrameExtractor.exe
            asset_name: VideoLastFrameExtractor.exe
          - os: macos-latest
            name: macOS
            artifact_name: VideoLastFrameExtractor
            asset_name: VideoLastFrameExtractor-macos
          - os: ubuntu-latest
            name: Linux
            artifact_name: VideoLastFrameExtractor
            asset_name: VideoLastFrameExtractor-linux
    
    runs-on: ${{ matrix.os }}
    name: 构建 ${{ matrix.name }} 版本
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
      
      - name: 设置 Python 环境
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: 安装依赖
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller Pillow
          pip install -r requirements.txt
      
      - name: 使用 PyInstaller 打包 (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        env:
          PYTHONUTF8: '1'
          PYTHONIOENCODING: 'utf-8'
        run: |
          pyinstaller --onefile --name "VideoLastFrameExtractor" --icon "favicon2.ico" --console --runtime-hook "runtime_hook.py" extract_last_frame.py
      
      - name: 使用 PyInstaller 打包 (macOS/Linux)
        if: matrix.os != 'windows-latest'
        env:
          PYTHONUTF8: '1'
          PYTHONIOENCODING: 'utf-8'
        run: |
          pyinstaller --onefile --name "VideoLastFrameExtractor" --console --runtime-hook "runtime_hook.py" extract_last_frame.py
      
      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.asset_name }}
          path: dist/${{ matrix.artifact_name }}
          retention-days: 90
      
      - name: 上传到 Release（仅在 Release 触发时）
        if: github.event_name == 'release'
        shell: bash
        run: |
          if [ "${{ matrix.os }}" == "windows-latest" ]; then
            gh release upload ${{ github.event.release.tag_name }} "dist/${{ matrix.artifact_name }}" --clobber
          else
            mv "dist/${{ matrix.artifact_name }}" "dist/${{ matrix.asset_name }}"
            gh release upload ${{ github.event.release.tag_name }} "dist/${{ matrix.asset_name }}" --clobber
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
